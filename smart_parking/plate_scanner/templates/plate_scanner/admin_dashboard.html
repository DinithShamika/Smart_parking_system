{% extends "plate_scanner/base.html" %}

{% block title %}Smart Parking - Admin Dashboard{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Header -->
    <div class="row mb-4">
    <!-- Just Arrived / Just Left -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <i class="bi bi-arrow-right"></i> Just Arrived (Last 10)
                </div>
                <div class="card-body">
                    <ul class="list-group">
                        {% for scan in just_arrived %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><strong>{{ scan.vehicle.plate_number }}</strong> <small class="text-muted">{{ scan.timestamp|timesince }} ago</small></span>
                            <span class="badge bg-success">Entry</span>
                        </li>
                        {% empty %}
                        <li class="list-group-item text-muted">No recent arrivals</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <i class="bi bi-arrow-left"></i> Just Left (Last 10)
                </div>
                <div class="card-body">
                    <ul class="list-group">
                        {% for scan in just_left %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><strong>{{ scan.vehicle.plate_number }}</strong> <small class="text-muted">{{ scan.timestamp|timesince }} ago</small></span>
                            <span class="badge bg-danger">Exit</span>
                        </li>
                        {% empty %}
                        <li class="list-group-item text-muted">No recent exits</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="display-5 fw-bold text-primary mb-2">
                        <i class="bi bi-speedometer2"></i> Smart Parking Dashboard
                    </h1>
                    <p class="text-muted">Comprehensive parking management and analytics</p>
                </div>
                <div class="text-end">
                    <h5 class="text-muted">{{ now|date:"F j, Y" }}</h5>
                    <small class="text-muted">{{ now|time:"H:i" }}</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Metrics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">{{ total_sessions }}</h4>
                            <small>Total Sessions</small>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-calendar-check fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">{{ active_sessions }}</h4>
                            <small>Currently Parked</small>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-car-front fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">${{ total_revenue|floatformat:2 }}</h4>
                            <small>Total Revenue</small>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-cash-coin fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">${{ pending_payments|floatformat:2 }}</h4>
                            <small>Pending Payments</small>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-clock-history fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Date Range Filter -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form method="GET" class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-control" name="start_date" value="{{ start_date|date:'Y-m-d' }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">End Date</label>
                            <input type="date" class="form-control" name="end_date" value="{{ end_date|date:'Y-m-d' }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">&nbsp;</label>
                            <div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-search"></i> Filter
                                </button>
                                <a href="{% url 'plate_scanner:admin_dashboard' %}" class="btn btn-outline-secondary">
                                    <i class="bi bi-arrow-clockwise"></i> Reset
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard Content -->
    <div class="row">
        <!-- Currently Parked Vehicles -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-car-front"></i> Currently Parked Vehicles
                    </h5>
                    <span class="badge bg-success">{{ currently_parked.count }}</span>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Plate Number</th>
                                    <th>Entry Time</th>
                                    <th>Duration</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for session in currently_parked %}
                                <tr>
                                    <td>
                                        <strong>{{ session.vehicle.plate_number }}</strong>
                                        {% if session.vehicle.is_registered %}
                                            <span class="badge bg-info ms-1">Registered</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ session.entry_time|time:"H:i" }}</td>
                                    <td>
                                        {% with session.entry_time|timesince:now as duration %}
                                            {{ duration }}
                                        {% endwith %}
                                    </td>
                                    <td>
                                        <span class="badge bg-success">Active</span>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center text-muted">No vehicles currently parked</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-clock-history"></i> Recent Activity
                    </h5>
                    <span class="badge bg-primary">{{ recent_scans.count }}</span>
                </div>
                <div class="card-body">
                    <div class="activity-timeline">
                        {% for scan in recent_scans %}
                        <div class="activity-item">
                            <div class="activity-icon {% if scan.scan_type == 'ENTRY' %}bg-success{% else %}bg-danger{% endif %}">
                                <i class="bi {% if scan.scan_type == 'ENTRY' %}bi-arrow-right{% else %}bi-arrow-left{% endif %}"></i>
                            </div>
                            <div class="activity-content">
                                <div class="d-flex justify-content-between">
                                    <strong>{{ scan.vehicle.plate_number }}</strong>
                                    <small class="text-muted">{{ scan.timestamp|timesince }} ago</small>
                                </div>
                                <div class="text-muted">
                                    {% if scan.scan_type == 'ENTRY' %}
                                        <span class="badge bg-success">Entrance Gate</span> Vehicle entered parking
                                    {% elif scan.scan_type == 'EXIT' %}
                                        <span class="badge bg-danger">Exit Gate</span> Vehicle exited parking
                                        {% if scan.parking_session and scan.parking_session.total_amount %}
                                            - ${{ scan.parking_session.total_amount|floatformat:2 }}
                                        {% endif %}
                                    {% else %}
                                        <span class="badge bg-secondary">Unknown Gate</span>
                                    {% endif %}
                                    <div class="mt-1 small">
                                        <b>Confidence:</b> {{ scan.confidence_score|floatformat:2 }}
                                        {% if scan.image %}
                                            | <b>Image:</b> <a href="{{ scan.image.url }}" target="_blank">View</a>
                                        {% endif %}
                                        {% if scan.parking_session %}
                                            | <b>Session:</b> {{ scan.parking_session.session_id }}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center text-muted">
                            <i class="bi bi-inbox fs-1"></i>
                            <p>No recent activity</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment History -->
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-cash-stack"></i> Payment History
                    </h5>
                    <span class="badge bg-success">{{ payment_history.count }}</span>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Plate Number</th>
                                    <th>Entry Time</th>
                                    <th>Exit Time</th>
                                    <th>Duration</th>
                                    <th>Amount</th>
                                    <th>Payment Time</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for session in payment_history %}
                                <tr>
                                    <td>
                                        <strong>{{ session.vehicle.plate_number }}</strong>
                                        {% if session.vehicle.is_registered %}
                                            <span class="badge bg-info ms-1">Registered</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ session.entry_time|date:"M j, H:i" }}</td>
                                    <td>{{ session.exit_time|date:"M j, H:i" }}</td>
                                    <td>
                                        {% with session.entry_time|timesince:session.exit_time as duration %}
                                            {{ duration }}
                                        {% endwith %}
                                    </td>
                                    <td>
                                        <strong class="text-success">${{ session.total_amount|floatformat:2 }}</strong>
                                    </td>
                                    <td>{{ session.payment_time|date:"M j, H:i" }}</td>
                                    <td>
                                        {% if session.is_paid %}
                                            <span class="badge bg-success">Paid</span>
                                        {% else %}
                                            <span class="badge bg-warning">Pending</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center text-muted">No payment history available</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-gear"></i> Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'plate_scanner:entrance' %}" class="btn btn-success">
                            <i class="bi bi-camera-video"></i> Entrance Scanner
                        </a>
                        <a href="{% url 'plate_scanner:exit' %}" class="btn btn-danger">
                            <i class="bi bi-camera-video"></i> Exit Scanner
                        </a>
                        <button class="btn btn-outline-primary" onclick="refreshStats()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh Stats
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-graph-up"></i> Statistics
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <h4 class="text-primary">{{ completed_sessions }}</h4>
                            <small class="text-muted">Completed</small>
                        </div>
                        <div class="col-6">
                            <h4 class="text-success">{{ active_sessions }}</h4>
                            <small class="text-muted">Active</small>
                        </div>
                    </div>
                    <hr>
                    <div class="row text-center">
                        <div class="col-6">
                            <h4 class="text-info">${{ total_revenue|floatformat:2 }}</h4>
                            <small class="text-muted">Revenue</small>
                        </div>
                        <div class="col-6">
                            <h4 class="text-warning">${{ pending_payments|floatformat:2 }}</h4>
                            <small class="text-muted">Pending</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle"></i> System Status
                    </h5>
                </div>
                <div class="card-body">
                    <div class="status-item">
                        <i class="bi bi-check-circle text-success"></i>
                        <span>Scanner System: Online</span>
                    </div>
                    <div class="status-item">
                        <i class="bi bi-check-circle text-success"></i>
                        <span>Database: Connected</span>
                    </div>
                    <div class="status-item">
                        <i class="bi bi-check-circle text-success"></i>
                        <span>Camera: Available</span>
                    </div>
                    <div class="status-item">
                        <i class="bi bi-check-circle text-success"></i>
                        <span>OCR Engine: Ready</span>
                    </div>
                    <hr>
                    <small class="text-muted">
                        Last updated: {{ now|time:"H:i:s" }}
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.activity-timeline {
    position: relative;
}

.activity-item {
    display: flex;
    align-items: flex-start;
    margin-bottom: 20px;
    position: relative;
}

.activity-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    margin-right: 15px;
    flex-shrink: 0;
}

.activity-content {
    flex: 1;
    padding-top: 5px;
}

.status-item {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
}

.status-item i {
    margin-right: 10px;
    font-size: 1.2em;
}

.table th {
    border-top: none;
    font-weight: 600;
    color: #495057;
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.badge {
    font-size: 0.75em;
}
</style>

{% block scripts %}
<script>
function refreshStats() {
    location.reload();
}

// Auto-refresh every 30 seconds
setInterval(function() {
    // Only refresh if user is on this page
    if (document.visibilityState === 'visible') {
        location.reload();
    }
}, 30000);

// Update time every second
setInterval(function() {
    const now = new Date();
    const timeElement = document.querySelector('.text-end small');
    if (timeElement) {
        timeElement.textContent = now.toLocaleTimeString();
    }
}, 1000);
</script>
{% endblock %}
{% endblock %} 