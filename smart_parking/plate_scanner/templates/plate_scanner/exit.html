{% extends "plate_scanner/base.html" %}

{% block title %}Smart Parking - Enhanced Exit Scanner{% endblock %}

{% block content %}


<div class="container py-4">
  <div class="row g-4 align-items-stretch flex-column-reverse flex-lg-row justify-content-center">
    <div class="col-12 col-lg-8 mb-4 mb-lg-0 d-flex flex-column">
      <div class="card shadow-lg h-100">
        <div class="card-header bg-danger text-white d-flex align-items-center justify-content-between">
          <span><i class="bi bi-door-closed"></i> <b>Exit Camera</b></span>
          <span id="scannerStatus" class="badge bg-success">Active</span>
        </div>
        <div class="card-body p-0 bg-dark rounded-bottom">
          <div class="camera-container position-relative rounded-bottom overflow-hidden" style="min-height:340px;">
<video id="camera" width="100%" style="max-height:45vh;min-height:180px;object-fit:cover;" autoplay muted playsinline></video>
            <div id="scanningOverlay" class="scanning-overlay" style="display: none;">
              <div class="spinner-border text-light" role="status"></div>
              <p class="mt-3 mb-0">Scanning for number plate...</p>
            </div>
          </div>
        </div>
      </div>
      <div class="card mt-4 shadow-sm">
        <div class="card-header bg-info text-white">
          <i class="bi bi-123"></i> <b>Real-Time Plate Detection</b>
        </div>
        <div class="card-body">
          <div id="realTimeText" class="display-6 text-center text-primary fw-bold" style="letter-spacing:2px;">
            <span class="text-muted">Waiting for scan...</span>
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-lg-4 d-flex flex-column">
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-secondary text-white">
          <i class="bi bi-gear"></i> <b>Controls</b>
        </div>
        <div class="card-body d-grid gap-3">
          <button id="startBtn" class="btn btn-danger btn-lg">
            <i class="bi bi-play-circle"></i> Start Scanner
          </button>
          <button id="stopBtn" class="btn btn-secondary btn-lg" disabled>
            <i class="bi bi-stop-circle"></i> Stop Scanner
          </button>
          <button id="quickScanBtn" class="btn btn-warning btn-lg">
            <i class="bi bi-lightning"></i> Quick Scan
<style>
.camera-container {
    position: relative;
    background: #000;
    border-radius: 8px;
    overflow: hidden;
}
.scanning-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: white;
    z-index: 10;
}
.detection-box {
    position: absolute;
    border: 3px solid #dc3545;
    border-radius: 8px;
    pointer-events: none;
    z-index: 5;
    animation: pulse-red 1s infinite;
}
@keyframes pulse-red {
    0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
    100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
}
.bg-gradient-danger {
    background: linear-gradient(45deg, #dc3545, #c82333);
}
.exit-item {
    padding: 15px;
    border-left: 4px solid #dc3545;
    margin-bottom: 15px;
    background: #f8f9fa;
    border-radius: 4px;
}
.exit-item.success {
    border-left-color: #28a745;
    background: #d4edda;
}
.exit-item.warning {
    border-left-color: #ffc107;
    background: #fff3cd;
}
.payment-info {
    background: linear-gradient(45deg, #28a745, #20c997);
    color: white;
    padding: 20px;
    border-radius: 8px;
    margin: 15px 0;
}
.duration-info {
    background: #e9ecef;
    padding: 15px;
    border-radius: 8px;
    margin: 10px 0;
}
@media (max-width: 991.98px) {
  .col-lg-8, .col-lg-4 {
    max-width: 100%;
    flex: 0 0 100%;
  }
  .camera-container video {
    max-height: 35vh !important;
  }
}
@media (max-width: 575.98px) {
  .camera-container video {
    max-height: 28vh !important;
    min-height: 120px !important;
  }
  .card-header, .card-body {
    padding-left: 0.7rem;
    padding-right: 0.7rem;
  }
  .display-6 {
    font-size: 1.2rem;
  }
}



.exit-item.warning {
    border-left-color: #ffc107;
    background: #fff3cd;
}

.payment-info {
    background: linear-gradient(45deg, #28a745, #20c997);
    color: white;
    padding: 20px;
    border-radius: 8px;
    margin: 15px 0;
}

.duration-info {
    background: #e9ecef;
    padding: 15px;
    border-radius: 8px;
    margin: 10px 0;
}
</style>

{% block scripts %}
<script>
$(document).ready(function() {
    const video = document.getElementById('camera');
    const startBtn = $('#startBtn');
    const stopBtn = $('#stopBtn');
    const quickScanBtn = $('#quickScanBtn');
    const testBtn = $('#testBtn');
    const exitResult = $('#exitResult');
    const exitResultContent = $('#exitResultContent');
    const scanningOverlay = $('#scanningOverlay');
    const cameraStatusText = $('#cameraStatusText');
    const scannerStatusText = $('#scannerStatusText');
    const accuracyText = $('#accuracyText');
    const detectionCount = $('#detectionCount');
    const realTimeText = $('#realTimeText');
    const detectionBox = $('#detectionBox');
    const todayExits = $('#todayExits');
    const totalRevenue = $('#totalRevenue');
    const recentExits = $('#recentExits');
    
    let scanInterval;
    let realTimeInterval;
    let scanCount = 0;
    let recentExitActivities = [];

    // Initialize
    checkCameraStatus();
    updateLiveStats();
    loadRecentExits();
    
    // Update stats every 30 seconds
    setInterval(updateLiveStats, 30000);
    setInterval(loadRecentExits, 10000);

    function checkCameraStatus() {
        $.get("{% url 'plate_scanner:camera_status' %}", function(data) {
            if (data.status === 'success') {
                if (data.working_cameras.length > 0) {
                    cameraStatusText.text('Available').removeClass('bg-warning bg-danger').addClass('bg-success');
                    scannerStatusText.text('Enhanced').removeClass('bg-warning bg-danger').addClass('bg-success');
                    accuracyText.text('High').removeClass('bg-warning bg-danger').addClass('bg-success');
                } else {
                    cameraStatusText.text('No Cameras').removeClass('bg-success bg-warning').addClass('bg-danger');
                    scannerStatusText.text('Unavailable').removeClass('bg-success bg-warning').addClass('bg-danger');
                    accuracyText.text('Low').removeClass('bg-success bg-warning').addClass('bg-danger');
                }
            } else {
                cameraStatusText.text('Error').removeClass('bg-success bg-warning').addClass('bg-danger');
                scannerStatusText.text('Error').removeClass('bg-success bg-warning').addClass('bg-danger');
                accuracyText.text('Error').removeClass('bg-success bg-warning').addClass('bg-danger');
            }
        }).fail(function() {
            cameraStatusText.text('Offline').removeClass('bg-success bg-warning').addClass('bg-danger');
            scannerStatusText.text('Offline').removeClass('bg-success bg-warning').addClass('bg-danger');
            accuracyText.text('Offline').removeClass('bg-success bg-warning').addClass('bg-danger');
        });
    }

    function updateLiveStats() {
        $.get("{% url 'plate_scanner:today_stats' %}", function(data) {
            todayExits.text(data.today_exits || 0);
            totalRevenue.text('$' + (data.today_revenue || 0).toFixed(2));
        });
    }

    function loadRecentExits() {
        // Simulate recent exits - in real app, this would come from API
        const exits = [
            { plate: 'ABC123', time: '2 min ago', duration: '2h 15m', amount: '$12.50', status: 'success' },
            { plate: 'XYZ789', time: '5 min ago', duration: '1h 30m', amount: '$8.75', status: 'success' },
            { plate: 'DEF456', time: '8 min ago', duration: '3h 45m', amount: '$18.25', status: 'warning' }
        ];
        
        let html = '';
        exits.forEach(exit => {
            html += `
                <div class="col-md-4">
                    <div class="exit-item ${exit.status}">
                        <div class="d-flex justify-content-between">
                            <strong>${exit.plate}</strong>
                            <small>${exit.time}</small>
                        </div>
                        <div class="text-muted">
                            <i class="bi bi-arrow-left-circle"></i> Vehicle Exit
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">Duration: ${exit.duration}</small><br>
                            <strong class="text-success">Amount: ${exit.amount}</strong>
                        </div>
                    </div>
                </div>
            `;
        });
        recentExits.html(html);
    }

    function updateStats() {
        detectionCount.text(scanCount);
    }

    // Test Camera
    testBtn.click(function() {
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                video.srcObject = stream;
                testBtn.text('Camera Working').removeClass('btn-outline-primary').addClass('btn-success');
                setTimeout(() => {
                    if (video.srcObject) {
                        video.srcObject.getTracks().forEach(track => track.stop());
                    }
                    testBtn.text('Test Camera').removeClass('btn-success').addClass('btn-outline-primary');
                }, 3000);
            })
            .catch(err => {
                testBtn.text('Camera Error').removeClass('btn-outline-primary').addClass('btn-danger');
                setTimeout(() => {
                    testBtn.text('Test Camera').removeClass('btn-danger').addClass('btn-outline-primary');
                }, 3000);
            });
    });

    // Start scanner
    startBtn.click(function() {
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                video.srcObject = stream;
                startBtn.prop('disabled', true);
                stopBtn.prop('disabled', false);
                quickScanBtn.prop('disabled', false);
                scannerStatusText.text('Active').removeClass('bg-success bg-warning').addClass('bg-primary');
                
                // Start backend scanner
                $.post("{% url 'plate_scanner:start_scan' %}", {
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                }, function(response) {
                    if (response.success) {
                        // Start real-time scanning
                        realTimeInterval = setInterval(realTimeScan, 200); // Scan every 0.2 seconds
                        showNotification('Exit scanner started successfully', 'success');
                    } else {
                        showNotification(response.message, 'error');
                        resetScanner();
                    }
                }).fail(function() {
                    showNotification('Failed to start scanner', 'error');
                    resetScanner();
                });
            })
            .catch(err => {
                showNotification(`Camera access denied: ${err.message}`, 'error');
            });
    });

    // Stop scanner
    stopBtn.click(function() {
        clearInterval(realTimeInterval);
        resetScanner();
        
        $.post("{% url 'plate_scanner:stop_scan' %}", {
            csrfmiddlewaretoken: '{{ csrf_token }}'
        }, function(response) {
            if (response.success) {
                showNotification('Scanner stopped', 'info');
            } else {
                showNotification(`Warning: ${response.message}`, 'warning');
            }
        });
    });

    // Quick scan button
    quickScanBtn.click(function() {
        if (!video.srcObject) {
            showNotification('Please start the scanner first', 'warning');
            return;
        }
        
        scanningOverlay.show();
        
        $.post("{% url 'plate_scanner:quick_scan' %}", {
            csrfmiddlewaretoken: '{{ csrf_token }}'
        }, function(data) {
            scanningOverlay.hide();
            
            if (data.status === 'success') {
                scanCount++;
                updateStats();
                
                // Simulate parking information
                const duration = '2h 15m';
                const amount = '$12.50';
                const entryTime = '10:30 AM';
                const exitTime = '12:45 PM';
                
                let resultHtml = `
                    <div class="alert alert-success">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h4 class="text-success mb-2">
                                    <i class="bi bi-check-circle"></i> Vehicle Exit Detected!
                                </h4>
                                <h3 class="fw-bold text-primary">${data.text}</h3>
                                <p class="mb-1">
                                    <strong>Confidence:</strong> ${(data.confidence * 100).toFixed(1)}%
                                </p>
                                <p class="mb-1">
                                    <strong>Time:</strong> ${new Date().toLocaleTimeString()}
                                </p>
                                <p class="mb-1">
                                    <strong>Mode:</strong> Enhanced (0.5s)
                                </p>
                            </div>
                            <div class="col-md-4 text-center">
                                <div class="display-4 text-danger">
                                    <i class="bi bi-car-front"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="payment-info">
                        <div class="row">
                            <div class="col-md-6">
                                <h5><i class="bi bi-cash-coin"></i> Payment Information</h5>
                                <h3 class="mb-0">${amount}</h3>
                                <small>Total Amount Due</small>
                            </div>
                            <div class="col-md-6">
                                <h5><i class="bi bi-clock"></i> Parking Duration</h5>
                                <h3 class="mb-0">${duration}</h3>
                                <small>Time Parked</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="duration-info">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Entry Time:</strong> ${entryTime}
                            </div>
                            <div class="col-md-6">
                                <strong>Exit Time:</strong> ${exitTime}
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center mt-3">
                        <button class="btn btn-success btn-lg me-2">
                            <i class="bi bi-check-circle"></i> Confirm Payment
                        </button>
                        <button class="btn btn-outline-secondary btn-lg">
                            <i class="bi bi-printer"></i> Print Receipt
                        </button>
                    </div>
                `;
                
                exitResultContent.html(resultHtml);
                exitResult.show();
                
                // Add to recent exits
                addRecentExit(data.text, duration, amount, 'success');
                
                // Auto-hide after 10 seconds
                setTimeout(() => {
                    exitResult.fadeOut();
                }, 10000);
                
                showNotification(`Vehicle "${data.text}" exit processed! Amount: ${amount}`, 'success');
                
            } else if (data.status === 'no_text') {
                showNotification('No number plate detected in 0.5 seconds', 'info');
            } else {
                showNotification(data.message, 'error');
            }
        }, function() {
            scanningOverlay.hide();
            showNotification('Quick scan failed', 'error');
        });
    });

    function addRecentExit(plate, duration, amount, status) {
        const exit = {
            plate: plate,
            time: 'Just now',
            duration: duration,
            amount: amount,
            status: status
        };
        recentExitActivities.unshift(exit);
        if (recentExitActivities.length > 6) {
            recentExitActivities.pop();
        }
        loadRecentExits();
    }

    function resetScanner() {
        if (video.srcObject) {
            video.srcObject.getTracks().forEach(track => track.stop());
        }
        startBtn.prop('disabled', false);
        stopBtn.prop('disabled', true);
        quickScanBtn.prop('disabled', true);
        scannerStatusText.text('Enhanced').removeClass('bg-primary bg-warning').addClass('bg-success');
        scanningOverlay.hide();
        detectionBox.hide();
        
        // Clear real-time display
        realTimeText.html(`
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> Start the exit scanner to see detected plates in real-time
            </div>
        `);
    }

    function realTimeScan() {
        $.post("{% url 'plate_scanner:real_time_scan' %}", {
            csrfmiddlewaretoken: '{{ csrf_token }}'
        }, function(data) {
            if (data.status === 'success' && data.texts && data.texts.length > 0) {
                scanCount++;
                updateStats();
                
                // Update real-time display
                let textHtml = '<div class="row">';
                data.texts.forEach((textInfo, index) => {
                    textHtml += `
                        <div class="col-md-6 mb-2">
                            <div class="alert alert-danger mb-0">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>${textInfo.text}</strong>
                                        <br>
                                        <small>Confidence: ${(textInfo.confidence * 100).toFixed(1)}%</small>
                                    </div>
                                    <div class="text-danger">
                                        <i class="bi bi-car-front-fill fs-4"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                textHtml += '</div>';
                
                realTimeText.html(textHtml);
                
                // Show detection box
                detectionBox.show();
                
                // Show notification for first text
                if (data.texts.length > 0) {
                    showNotification(`Number plate detected: ${data.texts[0].text}`, 'success');
                }
                
            } else if (data.status === 'no_text') {
                // Show "scanning" message
                realTimeText.html(`
                    <div class="alert alert-warning">
                        <i class="bi bi-search"></i> Scanning for number plates... Point camera at vehicle license plate
                    </div>
                `);
                detectionBox.hide();
            }
        }, function() {
            realTimeText.html(`
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> Scanner error. Please try again.
                </div>
            `);
            detectionBox.hide();
        });
    }

    function showNotification(message, type) {
        const alertClass = type === 'success' ? 'alert-success' : 
                          type === 'error' ? 'alert-danger' : 
                          type === 'warning' ? 'alert-warning' : 'alert-info';
        
        const notification = $(`
            <div class="alert ${alertClass} alert-dismissible fade show position-fixed" 
                 style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                <i class="bi bi-${type === 'success' ? 'check-circle' : 
                                  type === 'error' ? 'x-circle' : 
                                  type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `);
        
        $('body').append(notification);
        
        // Auto-remove after 3 seconds
        setTimeout(() => {
            notification.alert('close');
        }, 3000);
    }
});
</script>
{% endblock %}
{% endblock %}